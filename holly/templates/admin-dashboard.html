{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { display: flex; height: 100vh; background-color: #f4f6f9; }

        /* SIDEBAR */
        .sidebar { width: 250px; background: #ffffff; border-right: 1px solid #ddd; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; flex-shrink: 0; }
        .brand { display: flex; align-items: center; gap: 10px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .brand img { height: 35px; } .brand span { font-weight: bold; font-size: 18px; color: #333; }
        .menu-item { padding: 12px 15px; color: #555; text-decoration: none; border-radius: 6px; margin-bottom: 5px; font-size: 13px; display: flex; align-items: center; gap: 12px; transition: 0.2s; flex-shrink: 0; }
        .menu-item i { width: 16px; text-align: center; font-size: 14px; }
        .menu-item:hover { background-color: #e8f0fe; color: #1a73e8; }
        .menu-item.active { background-color: #1a73e8; color: white; }
        .menu-category { font-size: 11px; font-weight: bold; color: #999; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; padding-left: 15px; }
        .logout { margin-top: auto; color: #1a73e8; } .logout:hover { background-color: #e8f0fe; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: bold; color: #333; }
        .user-profile { font-size: 14px; color: #777; }

        /* STATS */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #1a73e8; }
        .stat-label { font-size: 12px; color: #777; margin-bottom: 5px; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; }

        /* TABLE */
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .table-header { font-size: 16px; font-weight: bold; color: #333; margin: 0; }
        .search-filter-box { display: flex; gap: 10px; position: relative; align-items: center; }
        .search-input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; width: 180px; }
        .date-input { padding: 7px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; width: 140px; color: #555; }
        .btn-filter { padding: 8px 16px; background: #fff; border: 1px solid #1a73e8; color: #1a73e8; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .btn-filter:hover { background: #e8f0fe; }
        .btn-export { padding: 8px 16px; background: #2e7d32; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .btn-export:hover { background: #1b5e20; }
        .filter-dropdown { position: absolute; top: 100%; right: 100px; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 150px; display: none; z-index: 10; margin-top: 5px; }
        .filter-dropdown.show { display: block; }
        .filter-option { padding: 10px; cursor: pointer; font-size: 13px; color: #333; }
        .filter-option:hover { background: #f4f6f9; color: #1a73e8; }

        table { width: 100%; border-collapse: collapse; }
        thead { background-color: transparent; color: #000000; border-bottom: 2px solid #333; }
        th, td { padding: 12px 15px; text-align: left; font-size: 13px; border-bottom: 1px solid #eee; }
        th { font-weight: 800; }
        tbody tr:hover { background-color: #f9f9f9; }

        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-pending { background: #fff3e0; color: #f57c00; }
        .status-done { background: #e8f5e9; color: #2e7d32; }

        .action-cell { display: flex; gap: 10px; }
        .action-btn { border: none; background: transparent; cursor: pointer; font-size: 14px; padding: 6px; border-radius: 4px; transition: all 0.2s; }
        .edit-btn { color: #1976d2; } .edit-btn:hover { background-color: #e3f2fd; }
        .delete-btn { color: #1a73e8; } .delete-btn:hover { background-color: #e8f0fe; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.show { display: flex; }
        .modal-card { background: white; width: 400px; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        .form-input, .form-select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #eee; color: #333; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn-save-edit { background: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-save-edit:hover { background: #0d47a1; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><img src="https://hollyblueinterio.com/images/abc/logo.png" alt="Logo"><span></span></div>
        <a href="/custom-admin-dashboard/" class="menu-item active"><i class="fa-solid fa-gauge"></i> Dashboard</a>
        <a href="/admin-floorplans/" class="menu-item"><i class="fa-solid fa-house"></i> Home</a>
        <div class="menu-category">Modules</div>
        <a href="/admin-kitchen/" class="menu-item"><i class="fa-solid fa-utensils"></i> Kitchen</a>
        <a href="/admin-accessories/" class="menu-item"><i class="fa-solid fa-box-open"></i> Kitchen Accessories</a>
        <a href="{% url 'admin_modules' 'TV Unit' %}" class="menu-item"><i class="fa-solid fa-tv"></i> TV Unit</a>
        <a href="{% url 'admin_modules' 'Washing Unit' %}" class="menu-item"><i class="fa-solid fa-shirt"></i> Washing Unit</a>
        <a href="{% url 'admin_modules' 'Mirror' %}" class="menu-item"><i class="fa-regular fa-square"></i> Mirror</a>
        <a href="{% url 'admin_modules' 'Partition' %}" class="menu-item"><i class="fa-solid fa-table-columns"></i> Partition</a>
        <a href="{% url 'admin_modules' 'Break Fast Table' %}" class="menu-item"><i class="fa-solid fa-mug-hot"></i> Breakfast Table</a>
        <a href="{% url 'admin_modules' 'BedCOT' %}" class="menu-item"><i class="fa-solid fa-bed"></i> Bedcot</a>
        <a href="{% url 'admin_modules' 'Head Board' %}" class="menu-item"><i class="fa-solid fa-layer-group"></i> Head Board</a>
        <a href="{% url 'admin_modules' 'Wall Panel' %}" class="menu-item"><i class="fa-solid fa-border-all"></i> Wall Panel</a>
        <a href="{% url 'admin_modules' 'Texture Paint' %}" class="menu-item"><i class="fa-solid fa-paint-roller"></i> Texture Paint</a>
        <a href="{% url 'admin_modules' 'Side Table' %}" class="menu-item"><i class="fa-solid fa-cube"></i> Side Table</a>
        <a href="{% url 'admin_modules' 'Wardrobe' %}" class="menu-item"><i class="fa-solid fa-door-closed"></i> Wardrobe</a>
        <a href="{% url 'admin_modules' 'Dressing' %}" class="menu-item"><i class="fa-solid fa-user-tie"></i> Dressing</a>

        <a href="{% url 'admin_modules' 'Vanity' %}" class="menu-item"><i class="fa-solid fa-bath"></i> Vanity</a>
        <div class="menu-category">Others</div>
        <a href="/custom-admin-login/" class="menu-item logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="page-title">Dashboard Overview</div>
            <div class="user-profile">Welcome, <strong>Admin</strong></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Enquiries</div>
                <div class="stat-value">{{ total_enquiries }}</div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-controls">
                <div class="table-header">Recent Enquiries</div>
                <div class="search-filter-box">
                    <input type="date" id="filterDate" class="date-input" title="Select Date" onchange="masterFilter()">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search..." onkeyup="masterFilter()">
                    <button class="btn-filter" onclick="toggleFilterMenu()"><i class="fa-solid fa-filter"></i> Status</button>
                    <button class="btn-export" onclick="exportToExcel()"><i class="fa-solid fa-file-excel"></i> Export</button>
                    <div id="filterDropdown" class="filter-dropdown">
                        <div class="filter-option" onclick="setStatusFilter('all')">All</div>
                        <div class="filter-option" onclick="setStatusFilter('new')">New</div>
                        <div class="filter-option" onclick="setStatusFilter('pending')">Pending</div>
                        <div class="filter-option" onclick="setStatusFilter('done')">Completed</div>
                    </div>
                </div>
            </div>

            <table id="enquiryTable">
                <thead>
                    <tr>
                        <th>ID</th> <th>Client Name</th> <th>Mobile</th> <th>Location</th> <th>Date</th> <th>Total Amount</th> <th>Status</th> <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for enq in enquiries %}
                    <tr id="row-{{ enq.id }}" class="enquiry-row" data-status="{{ enq.status }}">

                        <td style="font-weight:bold;">#{{ forloop.counter }}</td>

                        <td id="name-{{ enq.id }}">{{ enq.name }}</td>
                        <td id="mobile-{{ enq.id }}">{{ enq.mobile }}</td>
                        <td id="loc-{{ enq.id }}">{{ enq.location }}</td>
                        <td class="date-cell">{{ enq.created_at|date:"d M Y" }}</td>
                        <td id="amt-{{ enq.id }}">{{ enq.total_amount }}</td>
                        <td>
                            {% if enq.status == 'New Construction' or enq.status == 'new' %}
                                <span class="status-badge status-new" id="status-badge-{{ enq.id }}">{{ enq.status }}</span>
                            {% elif enq.status == 'Renovation' or enq.status == 'Under Construction' %}
                                <span class="status-badge status-pending" id="status-badge-{{ enq.id }}">{{ enq.status }}</span>
                            {% else %}
                                <span class="status-badge status-done" id="status-badge-{{ enq.id }}">{{ enq.status }}</span>
                            {% endif %}
                        </td>
                        <td class="action-cell">
                            <a href="/invoice/{{ enq.id }}/" target="_blank" class="action-btn" title="Download PDF" style="color:#2e7d32; text-decoration:none;"><i class="fa-solid fa-file-pdf"></i></a>
                            <button class="action-btn edit-btn" onclick="openEditModal('{{ enq.id }}', '{{ enq.name }}', '{{ enq.mobile }}', '{{ enq.location }}', '{{ enq.status }}', '{{ enq.total_amount }}')" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button class="action-btn delete-btn" onclick="deleteItem('{{ enq.id }}')" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="8" style="text-align:center;">No Enquiries Found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="modal-title">Edit Enquiry</div>
            <input type="hidden" id="editId">
            <div class="form-group"><label class="form-label">Client Name</label><input type="text" id="editName" class="form-input"></div>
            <div class="form-group"><label class="form-label">Mobile</label><input type="text" id="editMobile" class="form-input"></div>
            <div class="form-group"><label class="form-label">Location</label><input type="text" id="editLocation" class="form-input"></div>
            <div class="form-group"><label class="form-label">Total Amount</label><input type="text" id="editAmount" class="form-input"></div>
            <div class="form-group"><label class="form-label">Status</label><input type="text" id="editStatus" class="form-input" placeholder="e.g. New Construction"></div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeEditModal()">Cancel</button><button class="btn-save-edit" onclick="saveEdit()">Save Changes</button></div>
        </div>
    </div>

    <script>
        function exportToExcel() {
            let csv = [];
            const rows = document.querySelectorAll("table tr");
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].style.display !== 'none') {
                    let row = [], cols = rows[i].querySelectorAll("td, th");
                    for (let j = 0; j < cols.length - 1; j++) {
                        let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, "").trim();
                        data = data.replace(/"/g, '""');
                        row.push('"' + data + '"');
                    }
                    csv.push(row.join(","));
                }
            }
            const csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
            const downloadLink = document.createElement("a");
            downloadLink.download = "enquiries_list.csv";
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        let currentStatusFilter = 'all';
        function setStatusFilter(type) {
            currentStatusFilter = type;
            document.getElementById("filterDropdown").classList.remove("show");
            masterFilter();
        }

        function masterFilter() {
            const searchText = document.getElementById("searchInput").value.toLowerCase();
            const dateVal = document.getElementById("filterDate").value;
            const rows = document.querySelectorAll(".enquiry-row");

            rows.forEach(row => {
                const rowText = row.innerText.toLowerCase();
                const textMatch = rowText.includes(searchText);

                const statusText = row.querySelector(".status-badge").innerText.toLowerCase();
                let statusMatch = false;
                if(currentStatusFilter === 'all') statusMatch = true;
                else if(currentStatusFilter === 'new' && (statusText.includes('new') || statusText.includes('construction'))) statusMatch = true;
                else if(currentStatusFilter === 'pending' && (statusText.includes('under') || statusText.includes('renovation'))) statusMatch = true;
                else if(currentStatusFilter === 'done' && (statusText.includes('ready') || statusText.includes('possession'))) statusMatch = true;

                let dateMatch = true;
                if (dateVal) {
                    const rowDateStr = row.querySelector(".date-cell").innerText.trim();
                    const rowDate = new Date(rowDateStr);
                    const filterDate = new Date(dateVal);
                    rowDate.setHours(0,0,0,0);
                    filterDate.setHours(0,0,0,0);
                    if (rowDate.getTime() !== filterDate.getTime()) dateMatch = false;
                }

                if (textMatch && statusMatch && dateMatch) row.style.display = "";
                else row.style.display = "none";
            });
        }

        function toggleFilterMenu() { document.getElementById("filterDropdown").classList.toggle("show"); }
        window.onclick = function(e) { if (!e.target.matches('.btn-filter') && !e.target.matches('.btn-filter *')) { const dd = document.getElementById("filterDropdown"); if (dd.classList.contains('show')) dd.classList.remove('show'); } }

        function deleteItem(id) {
            if(confirm("Delete Enquiry?")) {
                fetch(`/api/delete-enquiry/${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': getCookie('csrftoken') } })
                .then(r => r.json()).then(d => { if(d.status === 'success') { document.getElementById('row-' + id).remove(); window.location.reload(); } });
            }
        }
        function openEditModal(id, n, m, l, s, a) {
            document.getElementById('editId').value = id; document.getElementById('editName').value = n; document.getElementById('editMobile').value = m;
            document.getElementById('editLocation').value = l; document.getElementById('editAmount').value = a; document.getElementById('editStatus').value = s;
            document.getElementById('editModal').classList.add('show');
        }
        function closeEditModal() { document.getElementById('editModal').classList.remove('show'); }
        function saveEdit() {
            const id = document.getElementById('editId').value;
            const data = { name: document.getElementById('editName').value, mobile: document.getElementById('editMobile').value, location: document.getElementById('editLocation').value, status: document.getElementById('editStatus').value, total_amount: document.getElementById('editAmount').value };
            fetch(`/api/update-enquiry/${id}/`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
            .then(r => r.json()).then(d => { if(d.status === 'success') { window.location.reload(); } });
        }
        function getCookie(name) { let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue; }
    </script>
</body>
</html>